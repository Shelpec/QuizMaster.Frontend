<div class="container mt-4">
  <h2 class="mb-3 text-center">List of Tests</h2>

  <!-- Кнопка Create Test (Wizard) -->
  <button
    class="btn btn-primary mb-3"
    (click)="openCreateTestWizard()"
    *ngIf="authService.isLoggedIn() && authService.isAdmin()"
  >
    + Create Test (Wizard)
  </button>

  <!-- Список тестов -->
  <ul class="list-group">
    <li class="list-group-item" *ngFor="let t of tests">
      <div class="d-flex justify-content-between">
        <!-- Левая часть -->
        <div>
          <h5>{{ t.name }}</h5>
          <p>
            <strong>Count:</strong> {{ t.countOfQuestions }}<br />
            <strong>Topic:</strong> {{ t.topicName || '---' }}<br />
            <strong>Created:</strong> {{ t.createdAt }}<br />
            <strong>Private?</strong> {{ t.isPrivate ? 'Yes' : 'No' }}<br />
            <strong>Random?</strong> {{ t.isRandom ? 'Yes' : 'No' }}<br />
            <strong>TestType:</strong> {{ t.testType }}<br />
            <strong>TimeLimit:</strong>
            {{ t.timeLimitMinutes != null ? (t.timeLimitMinutes + ' min') : '---' }}
          </p>
        </div>

        <!-- Правая часть: кнопки -->
        <div class="d-flex flex-column gap-2">
          <!-- Edit -->
          <button
            class="btn btn-sm btn-secondary"
            (click)="openEditModal(t)"
            *ngIf="authService.isLoggedIn() && authService.isAdmin()"
          >
            Edit
          </button>

          <!-- Manage Questions (Admin, isRandom=false) -->
          <button
            class="btn btn-sm btn-info"
            *ngIf="authService.isLoggedIn() && authService.isAdmin() && t.isRandom === false"
            (click)="openManageQuestions(t)"
          >
            Manage Q
          </button>

          <!-- Delete -->
          <button
            class="btn btn-sm btn-danger"
            (click)="deleteTest(t)"
            *ngIf="authService.isLoggedIn() && authService.isAdmin()"
          >
            Delete
          </button>

          <!-- Start Test (User) -->
          <button
            class="btn btn-sm btn-success"
            (click)="onStartTest(t)"
            *ngIf="authService.isLoggedIn()"
          >
            Start
          </button>

          <!-- Analytics -->
          <button
            class="btn btn-sm btn-primary"
            *ngIf="authService.isAdmin()"
            (click)="toggleShowAnalytics(t.id)"
          >
            {{ shownAnalytics[t.id] ? 'Hide' : 'Show' }} Analytics
          </button>
        </div>
      </div>

      <!-- Блок аналитики -->
      <div *ngIf="shownAnalytics[t.id]" class="p-2 mt-2 border">
        <app-test-analytics [testId]="t.id"></app-test-analytics>
      </div>
    </li>
  </ul>

  <!-- Пагинация -->
  <div class="mt-3 d-flex justify-content-center align-items-center">
    <button
      class="btn btn-outline-secondary me-2"
      (click)="prevPage()"
      [disabled]="currentPage <= 1"
    >
      Prev
    </button>
    <span class="me-2">
      Page {{ currentPage }} / {{ totalPages }}
    </span>
    <button
      class="btn btn-outline-secondary"
      (click)="nextPage()"
      [disabled]="currentPage >= totalPages"
    >
      Next
    </button>
  </div>
  <div class="text-muted text-center mt-2">
    Total Items: {{ totalItems }}
  </div>
</div>

<!-- Modal: Edit Test -->
<div
  class="modal fade"
  id="testModal"
  tabindex="-1"
  aria-labelledby="testModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="testModalLabel">Edit Test</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form>
          <!-- Name -->
          <div class="mb-3">
            <label class="form-label">Test Name</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="currentTest.name"
              name="testName"
            />
          </div>

          <!-- CountOfQuestions -->
          <div class="mb-3">
            <label class="form-label">Count Of Questions</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="currentTest.countOfQuestions"
              name="countOfQuestions"
              min="1"
            />
          </div>

          <!-- Topic -->
          <div class="mb-3">
            <label>Topic</label>
            <select class="form-select"
                    [(ngModel)]="currentTest.topicId"
                    name="topicId">
              <option [value]="undefined">-- No Topic --</option>
              <option *ngFor="let tp of topics" [value]="tp.id">
                {{ tp.name }}
              </option>
            </select>
          </div>

          <!-- IsPrivate -->
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="chkEditIsPrivate"
              [(ngModel)]="currentTest.isPrivate"
              name="editIsPrivate"
            />
            <label class="form-check-label" for="chkEditIsPrivate">
              Is Private?
            </label>
          </div>

          <!-- IsRandom -->
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="chkEditIsRandom"
              [(ngModel)]="currentTest.isRandom"
              name="editIsRandom"
            />
            <label class="form-check-label" for="chkEditIsRandom">
              Is Random?
            </label>
          </div>

          <!-- TestType -->
          <div class="mb-3">
            <label>Test Type</label>
            <select class="form-select"
                    [(ngModel)]="currentTest.testType"
                    name="editTestType">
              <option *ngFor="let tt of testTypes" [ngValue]="tt.value">
                {{ tt.label }}
              </option>
            </select>
          </div>

          <!-- TimeLimitMinutes -->
          <div class="mb-3">
            <label>Time Limit (minutes)</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="currentTest.timeLimitMinutes"
              name="editTimeLimitMinutes"
              min="0"
            />
            <small class="text-muted">0 или пусто, если без лимита</small>
          </div>

          <!-- Manage Access -->
          <div
            *ngIf="currentTest.id && currentTest.isPrivate"
            class="mt-2"
          >
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="openAccessModal()"
            >
              Manage Access
            </button>
          </div>
        </form>
      </div><!-- /modal-body -->

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Close
        </button>
        <button type="button"
                class="btn btn-primary"
                (click)="saveTest()">
          Save
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: Access -->
<div
  class="modal fade"
  id="accessModal"
  tabindex="-1"
  aria-labelledby="accessModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Manage Access for: {{ currentTest.name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Search -->
        <div class="mb-3">
          <label>Search users (by name / email)</label>
          <input type="text"
                 class="form-control"
                 placeholder="Enter name or email..."
                 [(ngModel)]="searchText"
                 (input)="onSearchUsers()">
        </div>

        <!-- Results -->
        <ul class="list-group mb-3" *ngIf="searchResults.length > 0">
          <li class="list-group-item d-flex justify-content-between align-items-center"
              *ngFor="let user of searchResults">
            <span>{{ user.fullName }} ({{ user.email }})</span>
            <!-- Важно: user.id -->
            <button class="btn btn-sm btn-primary"
                    (click)="addAccess(user.id)">
              +Add Access
            </button>
          </li>
        </ul>

        <hr>

        <!-- Current Access -->
        <h6>Current Access:</h6>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center"
              *ngFor="let au of currentAccessUsers">
            <span>{{ au.fullName }} ({{ au.email }})</span>
            <!-- au.userId -->
            <button class="btn btn-sm btn-danger"
                    (click)="removeAccess(au.userId)">
              Remove
            </button>
          </li>
        </ul>
      </div><!-- /modal-body -->

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Close
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: Manage Questions -->
<div
  class="modal fade"
  id="manageQuestionsModal"
  tabindex="-1"
  aria-labelledby="manageQuestionsLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          Manage Questions for Test: {{ currentTest.name }}
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                (click)="closeManageQuestionsModal()"></button>
      </div>

      <div class="modal-body">
        <!-- +Create Question -->
        <button class="btn btn-sm btn-outline-primary mb-2"
                (click)="openCreateQuestionModal()">
          + Create Question
        </button>

        <div class="row">
          <div class="col-md-6">
            <h6>Candidate Questions</h6>
            <ul class="list-group" style="max-height: 300px; overflow:auto;">
              <li class="list-group-item d-flex justify-content-between align-items-center"
                  *ngFor="let cq of candidateQuestions">
                <span>{{ cq.text }} ({{ cq.questionType }})</span>
                <button class="btn btn-sm btn-success"
                        (click)="addQuestionToTest(cq.id)">
                  +Add
                </button>
              </li>
            </ul>
          </div>

          <div class="col-md-6">
            <h6>Test Questions</h6>
            <ul class="list-group" style="max-height: 300px; overflow:auto;">
              <li class="list-group-item d-flex justify-content-between align-items-center"
                  *ngFor="let tq of testQuestions">
                <span>{{ tq.text }} ({{ tq.questionType }})</span>
                <button class="btn btn-sm btn-danger"
                        (click)="removeQuestionFromTest(tq.id)">
                  Remove
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div><!-- /modal-body -->

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
                (click)="closeManageQuestionsModal()">
          Close
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: CreateQuestion -->
<div
  class="modal fade"
  id="createQuestionModal"
  tabindex="-1"
  aria-labelledby="createQuestionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          Create a new Question
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form>
          <!-- Question Text -->
          <div class="mb-3">
            <label>Question Text</label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="newQuestion.text"
                   name="newQuestionText">
          </div>

          <!-- QuestionType -->
          <div class="mb-3">
            <label>Question Type</label>
            <select class="form-select"
                    [(ngModel)]="newQuestion.questionType"
                    name="newQuestionType">
              <option *ngFor="let qt of questionTypes" [ngValue]="qt.value">
                {{ qt.label }}
              </option>
            </select>
          </div>

          <!-- correctTextAnswer => if OpenText -->
          <div class="mb-3" *ngIf="newQuestion.questionType === 3">
            <label>Correct Text Answer</label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="newQuestion.correctTextAnswer"
                   name="newQuestionCorrectTextAnswer">
          </div>

          <!-- AnswerOptions => if not OpenText -->
          <div class="mb-3" *ngIf="newQuestion.questionType !== 3">
            <label>Answer Options</label>
            <div class="row g-2 mb-2"
                 *ngFor="let ans of newQuestion.answerOptions; let i = index">
              <div class="col-8">
                <input type="text"
                       class="form-control"
                       [(ngModel)]="ans.text"
                       name="answerText{{i}}">
              </div>
              <div class="col-4 d-flex align-items-center"
                   *ngIf="newQuestion.questionType !== 2">
                <input type="checkbox"
                       class="form-check-input me-1"
                       [(ngModel)]="ans.isCorrect"
                       name="answerIsCorrect{{i}}">
                <label class="form-check-label">
                  IsCorrect?
                </label>
              </div>
            </div>

            <button type="button"
                    class="btn btn-sm btn-outline-secondary"
                    (click)="addOptionToNewQuestion()">
              +Add Option
            </button>
          </div>
        </form>
      </div><!-- /modal-body -->

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Close
        </button>
        <button type="button"
                class="btn btn-primary"
                (click)="saveNewQuestion()">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- =============== WIZARD MODAL ============== -->
<div
  class="modal fade"
  id="wizardModal"
  tabindex="-1"
  aria-labelledby="wizardModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create Test (Wizard)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Шаг 1 (Category) -->
        <div *ngIf="wizardStep === 1">
          <h5>Step 1: Select or Create Category</h5>

          <label>Select Category:</label>
          <select class="form-select"
                  [(ngModel)]="selectedCategoryId"
                  name="selectedCategoryId">
            <option [value]="null">-- choose category --</option>
            <option *ngFor="let cat of categories" [value]="cat.id">
              {{ cat.name }}
            </option>
          </select>

          <div class="mt-3">
            <button class="btn btn-outline-secondary"
                    (click)="toggleNewCategoryForm()">
              {{ showNewCategoryForm ? 'Cancel' : '+ Create Category' }}
            </button>
          </div>

          <div class="mt-2" *ngIf="showNewCategoryForm">
            <label>New Category Name:</label>
            <input type="text"
                   class="form-control mb-2"
                   [(ngModel)]="newCategoryName"
                   name="newCategoryName">
            <button class="btn btn-sm btn-info"
                    (click)="saveNewCategory()">
              Save Category
            </button>
          </div>
        </div>

        <!-- Шаг 2 (Topic) -->
        <div *ngIf="wizardStep === 2">
          <h5>Step 2: Select or Create Topic</h5>
          <p class="text-muted">Category ID = {{ selectedCategoryId }}</p>

          <label>Select Topic:</label>
          <select class="form-select"
                  [(ngModel)]="selectedTopicId"
                  name="selectedTopicId">
            <option [value]="null">-- choose topic --</option>
            <option *ngFor="let tp of wizardTopics" [value]="tp.id">
              {{ tp.name }}
            </option>
          </select>

          <div class="mt-3">
            <button class="btn btn-outline-secondary"
                    (click)="toggleNewTopicForm()">
              {{ showNewTopicForm ? 'Cancel' : '+ Create Topic' }}
            </button>
          </div>

          <div class="mt-2" *ngIf="showNewTopicForm">
            <label>New Topic Name:</label>
            <input type="text"
                   class="form-control mb-2"
                   [(ngModel)]="newTopicName"
                   name="newTopicName">
            <button class="btn btn-sm btn-info"
                    (click)="saveNewTopic()">
              Save Topic
            </button>
          </div>
        </div>

        <!-- Шаг 3 (Test Info) -->
        <div *ngIf="wizardStep === 3">
          <h5>Step 3: Test Info</h5>
          <p class="text-muted">Topic ID = {{ selectedTopicId }}</p>

          <div class="mb-3">
            <label>Test Name</label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="wizardTestName"
                   name="wizardTestName">
          </div>
          <div class="mb-3">
            <label>Count Of Questions</label>
            <input type="number"
                   class="form-control"
                   [(ngModel)]="wizardCountOfQuestions"
                   name="wizardCountOfQuestions"
                   min="1">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox"
                   class="form-check-input"
                   id="chkWizIsPrivate"
                   [(ngModel)]="wizardIsPrivate"
                   name="wizardIsPrivate">
            <label class="form-check-label" for="chkWizIsPrivate">
              Is Private?
            </label>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox"
                   class="form-check-input"
                   id="chkWizIsRandom"
                   [(ngModel)]="wizardIsRandom"
                   name="wizardIsRandom">
            <label class="form-check-label" for="chkWizIsRandom">
              Is Random?
            </label>
          </div>
          <div class="mb-3">
            <label>Test Type</label>
            <select class="form-select"
                    [(ngModel)]="wizardTestType"
                    name="wizardTestType">
              <option *ngFor="let tt of testTypes" [ngValue]="tt.value">
                {{ tt.label }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label>Time Limit (minutes)</label>
            <input type="number"
                   class="form-control"
                   [(ngModel)]="wizardTimeLimitMinutes"
                   name="wizardTimeLimitMinutes"
                   min="0">
            <small class="text-muted">
              Leave empty or 0 if no time limit
            </small>
          </div>
        </div>
      </div><!-- /modal-body -->

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                *ngIf="wizardStep > 1"
                (click)="wizardStep = wizardStep - 1">
          Back
        </button>

        <button type="button"
                class="btn btn-primary"
                *ngIf="wizardStep === 1"
                (click)="goToStep2()">
          Next
        </button>

        <button type="button"
                class="btn btn-primary"
                *ngIf="wizardStep === 2"
                (click)="goToStep3()">
          Next
        </button>

        <button type="button"
                class="btn btn-success"
                *ngIf="wizardStep === 3"
                (click)="saveWizardTest()">
          Finish
        </button>
      </div>
    </div>
  </div>
</div>
